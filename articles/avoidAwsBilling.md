# 背景
> AWSのクラウド破産の話を何度か聞いたことがあり、どうにかして課金額を可能な限り下げ、クラウド破産の不安を払拭したうえで効果的にクラウドの学習ができないだろうかと考えたのがこの記事を作成した理由です。

# 作業内容
> 具体的な手法としては自宅に物理サーバーを設置し、それを仮想化することが簡単な方法だと思い、やってみました。
> 物理環境とクラウド環境には違いがありますが、それはある程度、AWSの使い方がわかれば環境の差分を埋めるのはそこまで難しくないと思います。
> どうしても実行しておきたいのはAWSのVPCとEC2環境の再現です。
> なぜかというとAWS学習時以外には使用しないEC2サーバーを停止し忘れたことで余計な課金が発生したという話を一番よく聞いたからです。
> どうしても必要というわけではありませんが、外部ネットワークと内部ネットワークを分けてネットワークを構築しておきたかったので、それも行います。
 AWSは従量課金制であることが利点ですが今回の場合は、あくまでも個人の学習用環境の構築が目的なので長期的な課金と比較すると確実に元が取れるはずです。

# 用意するもの(そこそこ初期費用がかかります。)
- OSがインストールされていないサーバー (私は中古サーバー(ProLiant ML30 Gen10)を購入したので、いろいろ欠落している部品がありました。例えば、ハードディスクをサーバーに挿入するためのハードディスクトレイやHDDなどはありませんでした。このサーバーの見た目はデスクトップです。)
- モニター
- ルーター (私の環境では既存のルーターは勝手にいじれないので、既存のルーターの配下に別のルーターを接続する必要がありました。)
- スイッチ (任天堂スイッチではありません。)
- ルーターとスイッチに接続するコンソールケーブル
- データ用DVD
- ESXiのisoファイル (無料でダウンロード可能です。)
- LANケーブル
- TeraTerm (用意するものが必ずTeraTermである必要はありません。Puttyなどでもよいと思います。必須ではありませんが、自動でログが取られるように設定したほうがよいでしょう。)

> 中古サーバーでは以下のものが欠落している可能性があります。
- ハードディスク (お金に余裕があればSSDのほうが良いかもしれません)
- メモリ (サーバーのメモリスロット数によりますが、例えば4スロットあれば16GBx4枚か32GBx4枚ぐらいあれば学習用としては十分だと思います。)
- ハードディスクトレイ
- OS (この記事ではOSの代わりにサーバーにVMware ESXiを入れます。VMwarePlayerは使いません。)

# 手順1 サーバーセットアップ
- データ用dvdにESXiのisoファイルを焼きこむ
![burnDiskImage](articles/images/burnDiskImage.png)

- サーバーを起動後にESXiのisoファイルを焼きこんだdvdをサーバーに読み込ませる。
- **後で画像を挿入する**

- BIOSを開く
- **後で画像を挿入する**

- BIOSにてdvdでサーバーを起動させる
- **後で画像を挿入する**

- しばらくするとESXiのインストールウィザードがモニターに表示されるので、案内通りにインストールを進める。一方通行なので、迷うことはないと思います。

# 手順2 TeraTermで自動でログをとるように設定する。
- **後で画像を挿入する**

# 手順3 ルーターを設定する
> 私はCisco ルーター 892Jを用意しました。メルカリで買いました。
- **後で画像を挿入する**

- まず、このルーターを既存の家庭用ルーターの空いているポートにLANケーブルでつなぎます。
- **後で画像を挿入する**

- WANリンクであるGigabitEthernetのインターネットと既存の家庭用ルーターを接続する

- ルーターにコンソールケーブルを挿入し、反対側のUSB端子をPCに接続する
- **後で画像を挿入する**

- ルーターを起動する (私が購入したCisco ルータ 892Jには電源ボタンはなく、電源ケーブル挿入後にすぐ起動しました。)

- TeraTermを起動し、Serialを選択する。
- **後で画像を挿入する**

- ルーターの起動が完了したら、任意のインターフェースをトランクモードに設定する。このインターフェースをスイッチに接続します。

- 家庭用ルーターに割り当てられているプライベートIPアドレスが何かを確認する。
> コマンドプロンプトを開き、コマンド*ipconfig*にてデフォルトゲートウェイとしてルーターに割り当てられているプライベートIPアドレスを確認する。
> 仮にこのプライベートIPアドレスが192.168.3.1 255.255.255.0だったという設定で話を進めます。
> 既存の家庭用ルーターに割り当てられているプライベートIPアドレスが何かを確認するだけで、特に設定変更などは行いません。
- **後で画像を挿入する**

# 手順4 スイッチのセットアップ
> Catalyst 2960を例に出して、説明します。
- 手順3で家庭用ルーターに割り当てられているアドレスが192.168.3.1/24だと判明したので、このアドレスが属しているネットワーク192.168.3.0/24を192.168.3.0/25と192.168.3.128/25に分けます。
- vlan1が最初から存在しており、全てのfastEthernetのインターフェースがvlan1に割り当てられています。
- vlan1にネットワーク192.168.3.128/25の中からまだ使用されていない任意のプライベートIPアドレスを割り当てます。
- **後で画像を挿入する**
- 任意のインターフェースをトランクに設定する
- **後で画像を挿入する**

# 手順5 Cisco ルーター 892Jにルート設定を行う
- 以下の画像のように192.168.3.0/25と192.168.3.128/25を設定する。
- **後で画像を挿入する**

- 192.168.3.128/25のネットワークに属しているデバイスがインターネットにアクセスできるようにするためのルートも設定する
- **後で画像を挿入する**

- ルーター上でトランクに設定したインターフェースとスイッチ上でトランクに設定したインターフェースをLANケーブルでつなぐ

- 192.168.3.128/25のデバイスのプライベートIPアドレスがISPから払いだされているパブリックIPアドレスと紐づけられるようにするためにNAPTを設定する。
- **後で画像を挿入する**

- 以上の手順で設定は完了です。では192.168.3.128/25のネットワークの中からまだ使用されていない任意のプライベートIPアドレスとスイッチのvlan1のプライベートIPアドレスをデフォルトゲートウェイとしてPCに設定し、念のためWi-Fiを無効化することで確実に有線の経路が使用されるようにして、コマンドプロンプトを開き、**tracert 192.168.3.1**にて通信経路を確認してみましょう。
```
C:\Users\PC_User>ipconfig

Windows IP Configuration


Ethernet adapter E1:

   Connection-specific DNS Suffix
   IPv4 Address. . . . . . . . . . . : 192.168.3.140
   Subnet Mask . . . . . . . . . . . : 255.255.255.128
   Default Gateway . . . . . . . . . : 192.168.3.129

C:\Users\PC_User>tracert 192.168.3.1

Tracing route to 192.168.3.1 over a maximum of 30 hops

  1    <1 ms    <1 ms    <1 ms  Router [192.168.3.129]
  2     2 ms     1 ms     1 ms  192.168.3.1

Trace complete.

C:\Users\PC_User>
```
- やや変則的な方法ではありますが、これで家庭用ルーターの配下にルーターを新規追加したため、192.168.3.128/25のネットワークがインターネットに抜けるには必ず192.168.3.0/25のネットワークを経由することになるとわかると思います。
- ルーターでルート設定をしたときに各ルートのネクストホップを家庭用ルーターのデフォルトゲートウェイ192.168.3.1に設定しました。
- **後で画像を挿入する**

# 手順6
- 以上で実際のAWS VPCと比較すると小規模ではありますが、VPCの再現ができました。後はwebブラウザでESXiにログインして、仮想マシンを立ち上げます。
- **後で画像を挿入する**